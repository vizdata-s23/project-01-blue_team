---
title: "What makes a good chocolate bar?"
subtitle: "STA/ISS 313 - Project 1"
author: "The Blue Team: Ryan Mitchell, Luke Thomas, Jason Yang"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: packages-and-data
#| message: false

library(tidyverse)
library(ggridges)
library(plotly)

chocolate <- readr::read_csv("data/chocolate.csv")
color_scheme <- c("#A78B71", "#F7C815", "#EC9704", "#9C4A1A")
```

## Abstract

(1 paragraph): Project abstract.

------------------------------------------------------------------------

## Introduction

For our first project, our team decided to analyze the Chocolate Bar Ratings data set, which comes from the "Flavors of Cacao" database provided by Georgios and Kelsey (two contributors to the TidyTuesday repository). Since chocolate is such a ubiquitous substance in America, our team decided to use this dataset because we were mildly interested in learning more about chocolate and the details about where its produced and how the different ingredients affect its perceived review.

Within the dataset, there are categorical variables such as ingredients and the country of bean origin, and there are numerical variables such as the cocoa percentage and the review score rating of the chocolate. The review scores of the chocolate are on a scale of 1.0 to 5.0 and combine a mixture of both objective and subjective factors. By the end of this project, our team will have used a combination of these variables to create visualizations that reveal more about the intricacies of chocolate production and review.

## Question 1: Where is the best chocolate produced?

### Introduction

(1-2 paragraphs): Introduction to the question and what parts of the dataset are necessary to answer the question. Also discuss why you're interested in this question.

For this question, we specifically want to explore how chocolate bar ratings for bars originating from different countries impacted by factors like time and cocoa percentage. While dozens of countries are represented in the data, we referenced statistics from the International Cocoa Organization to find that 81% of the market share for fine aroma cocoa is owned by Latin America, with the top four countries of production being Ecuador, Dominican Republic, Peru, and Venezuela. We will use these four countries to answer our question, as identified in the \`country_of_bean_origin\` variable. Additionally, we will make use of the 'review_date', 'cocoa_percent', and 'rating' variables. We are interested in this question because many chocolate bars boast their country of origin on the wrapper, and we would love to know which is frequently associated with the highest rated chocolate!

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

To visualize the chocolate bar ratings over time for the four countries in question, we have chosen to calculate the mean rating for each country for each year in the data (2006-2021), then produce a single line plot with color mapping. The line plot offers an intuitive way to visualize an effect over time, with the year on the x-axis, to see how ratings have changed over the 15-year period. Additionally, using a single line plot with color mapping allows for easy comparison across the four countries, and it would not make as much sense to facet four different plots, each with a single line.

To visualize the effect of cocoa percentage on chocolate bar ratings for the four countries, we decided to produce scatter plots of rating vs. cocoa percentage, faceted by the country of origin. Additionally, a line of best fit has been added to each plot to visualize the overall trend for each country. In this instance, we opted for a scatter plot, since the continuous nature of the cocoa percentage variable did not facilitate the use of a summary statistic, and binning the variable was not effective due to the inconsistent number of observations for different cocoa percentage ranges. The line of best fit allows the viewer to easily identify the trend for each country, and the plot was faceted rather than color mapped or shape mapped on a single plot because the cluttered nature of the scatter plot would be difficult to interpret on a single plot with this many observations.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

```{r q1-viz1-data}
q1_viz1 <- chocolate |>
  filter(country_of_bean_origin %in%
           c("Ecuador", "Dominican Republic", "Peru", "Venezuela")) |>
  group_by(country_of_bean_origin, review_date) |>
  mutate(avg_rating = mean(rating)) |>
  select(country_of_bean_origin, review_date, avg_rating) |>
  ungroup() |>
  distinct()
```

```{r q1-viz1-plot}
q1_plot1 <- ggplot(q1_viz1, aes(x = review_date,
                    y = avg_rating,
                    color = country_of_bean_origin)) +
  geom_line() +
  geom_point(aes(text = paste(
                      "Country:", country_of_bean_origin,
                      "\nReview Year:", review_date,
                      "\nAverage Rating:", round(avg_rating, 2)
                    ))) +
  scale_x_continuous(breaks = seq(2006, 2021, 3)) +
  scale_color_manual(values = color_scheme) +
  labs(x = "Review Year",
       y = "Average Rating (From 1 to 4)",
       color = "Country of Bean Origin") +
  theme_minimal() +
  theme(legend.position = "bottom")
ggplotly(q1_plot1, tooltip = "text") |>
  layout(title = list(text = paste0("Chocolate Bar Ratings Over Time",
                                    "<br>",
                                    "<sup>",
                                    "By Country of Cocoa Bean Origin",
                                    "</sup>")),
         legend = list(orientation = "h", y = -0.2))
```

[customize plotly tooltip](https://gist.github.com/matt-dray/8e5d03e32318da90ee53cd35d81871c0) [plotly titles](https://datascott.com/blog/subtitles-with-ggplotly/) [legend position ggplotly](https://github.com/plotly/plotly.R/issues/1049)

```{r q1-viz2-data}
q1_viz2 <- chocolate |>
  filter(country_of_bean_origin %in%
           c("Ecuador", "Dominican Republic", "Peru", "Venezuela")) |>
  mutate(cocoa_percent = as.numeric(gsub("%", "", cocoa_percent)))
```

```{r q1-viz2-plot}
ggplot(q1_viz2, aes(x = cocoa_percent,
                    y = rating,
                    color = country_of_bean_origin)) +
  facet_wrap(~country_of_bean_origin) +
  geom_point(show.legend = FALSE) +
  geom_smooth(method = "lm") +
  theme_minimal()
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.

## Question 2: What does the best chocolate contain?

### Introduction

(1-2 paragraphs): Introduction to the question and what parts of the dataset are necessary to answer the question. Also discuss why you're interested in this question.

For this question, we are interested in exploring some of the main ingredients present in many chocolate bars, and specifically answering the question - PASTE QUESTION HERE. The ingredients variable in the dataset includes abbreviations that indicate the presence of common ingredients in each chocolate bar (B = Beans, S = Sugar, S\* = Sweetener other than white cane or beet sugar, C = Cocoa Butter, V = Vanilla, L = Lecithin, Sa = Salt), as well as a number indicating how many of these ingredients are present. Other relevant variables for this question are the chocolate bar rating, on a scale of 1 to 5, and the date that the chocolate bar was reviewed, a year from 2006 to 2021. This question is interesting and relevant, because it is advantageous to know which ingredients correspond with higher chocolate bar ratings, and it could be fascinating to know if and how these opinions have changed over time. When browsing chocolate bars in the store, this analysis can give someone a better idea of which ones will be the best!

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

```{r q2-viz1-data}
q2_viz1 <- chocolate |>
  mutate(num_ingredients = as.factor(substr(ingredients, 1, 1)),
         sweeteners = if_else(grepl("S\\*", chocolate$ingredients), 1, 0)) |>
  drop_na(ingredients)
```

```{r q2-viz1-plot}
ggplot(q2_viz1, aes(x = rating, y = num_ingredients)) +
  geom_density_ridges() +
  stat_density_ridges(
    geom = "density_ridges_gradient", calc_ecdf = TRUE,
    quantiles = 4, quantile_lines = TRUE
  )
```

```{r q2-viz2-data}
q2_viz2 <- chocolate |>
  mutate(has_beans = if_else(grepl("B", chocolate$ingredients), 1, 0),
         has_sugar = if_else(grepl("S$", chocolate$ingredients) |
                         grepl("S,", chocolate$ingredients), 1, 0),
         has_sweetener = if_else(grepl("S\\*", chocolate$ingredients), 1, 0),
         has_cocoa_butter = if_else(grepl("C", chocolate$ingredients), 1, 0),
         has_vanilla = if_else(grepl("V", chocolate$ingredients), 1, 0),
         has_lecithin = if_else(grepl("L", chocolate$ingredients), 1, 0),
         has_salt = if_else(grepl("Sa", chocolate$ingredients), 1, 0)) |>
  select(rating, review_date, starts_with("has")) |>
  pivot_longer(cols = starts_with("has"),
               names_to = "ingredient",
               values_to = "contains") |>
  filter(contains == 1) |>
  mutate(ingredient = substr(ingredient, 5, 20)) |>
  group_by(ingredient, review_date) |>
  mutate(avg_rating = mean(rating)) |>
  select(ingredient, review_date, avg_rating) |>
  ungroup() |>
  distinct()
```

```{r q2-viz2-plot}
q2_plot2 <-ggplot(q2_viz2,
                  aes(x = review_date, y = avg_rating, color = ingredient)) +
  geom_line(show.legend = FALSE) +
  geom_point(show.legend = FALSE) +
  theme_minimal()
ggplotly(q2_plot2)
```

```{r}
#| label: ingredient-number-viz

chocolate |>
  drop_na(ingredients) |>
  mutate(num_ingredients = as.factor(substr(ingredients, 1, 1))) |>
  mutate(year_cat = case_when(review_date <= 2010 ~ '2006-2010',
                              review_date <= 2015 ~ '2011-2015',
                              review_date <= 2021 ~ '2016-2021')) |>
  filter(num_ingredients %in% c(2,3,4,5)) |>
  ggplot(aes(x = num_ingredients, y = rating, group = year_cat, fill = year_cat)) +
  geom_bar(position = "dodge", stat = "summary", fun.y = "mean")
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.
